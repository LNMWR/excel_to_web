<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>表格文件（.xlsx, .csv）上传与下载工具</title>
    <!-- 引入SheetJS和PapaParse库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        .container {
            max-width: 1000px;
            margin: auto;
        }
        input[type="file"] {
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        td {
            min-width: 100px;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        #fileTypeDisplay {
            margin-bottom: 20px;
            font-weight: bold;
        }
        .button-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>文件上传与下载工具</h1>
    <div class="button-group">
        <input type="file" id="fileInput" accept=".xlsx,.csv" style="display: none;">
        <button onclick="document.getElementById('fileInput').click()">上传表格文件</button>
        <button id="clearDataBtn" disabled>清空数据</button>
    </div>
    <div id="fileTypeDisplay"></div>
    <div id="tableContainer"></div>
    <button id="downloadBtn" disabled>下载修改后的文件</button>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const tableContainer = document.getElementById('tableContainer');
    const downloadBtn = document.getElementById('downloadBtn');
    const fileTypeDisplay = document.getElementById('fileTypeDisplay');
    const clearDataBtn = document.getElementById('clearDataBtn');

    let headers = [];
    let dataRows = [];
    let fileType = '';

    // 检查localStorage中是否有保存的数据
    window.addEventListener('load', () => {
        const savedFileType = localStorage.getItem('fileType');
        const savedHeaders = localStorage.getItem('tableHeaders');
        const savedDataRows = localStorage.getItem('tableDataRows');
        if (savedFileType && savedHeaders && savedDataRows) {
            fileType = savedFileType;
            headers = JSON.parse(savedHeaders);
            dataRows = JSON.parse(savedDataRows);
            fileTypeDisplay.textContent = `当前文件类型：.${fileType}`;
            displayTable(headers, dataRows);
            downloadBtn.disabled = false;
            clearDataBtn.disabled = false;
        }
    });

    // 读取文件
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();
        fileType = ext;
        fileTypeDisplay.textContent = `当前文件类型：.${ext}`;
        clearDataBtn.disabled = false;

        reader.onload = (evt) => {
            const data = evt.target.result;
            if (ext === 'csv') {
                Papa.parse(data, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        headers = results.meta.fields;
                        dataRows = results.data;
                        displayTable(headers, dataRows);
                        saveData();
                    }
                });
            } else if (ext === 'xlsx') {
                const workbook = XLSX.read(data, {type: 'binary'});
                const firstSheet = workbook.SheetNames[0];
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], {header:1});
                if (sheetData.length === 0) {
                    alert('XLSX文件为空！');
                    return;
                }
                headers = sheetData[0];
                dataRows = sheetData.slice(1);
                displayTable(headers, dataRows);
                saveData();
            } else {
                alert('仅支持CSV和XLSX文件');
            }
        };

        if (ext === 'csv') {
            reader.readAsText(file);
        } else if (ext === 'xlsx') {
            reader.readAsBinaryString(file);
        }
    });

    // 显示表格
    function displayTable(headers, dataRows) {
        tableContainer.innerHTML = ''; // 清空之前的表格
        const table = document.createElement('table');
        table.id = 'dataTable'; // 添加唯一ID以便插件识别
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        // 创建表头
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // 创建数据行
        dataRows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.dataset.row = rowIndex; // 添加行数据属性
            headers.forEach((header, cellIndex) => {
                const td = document.createElement('td');
                td.contentEditable = "true";
                td.textContent = row[cellIndex] !== undefined ? row[cellIndex] : '';
                td.dataset.column = cellIndex; // 使用列索引作为列数据属性
                // 添加事件监听器以更新 dataRows
                td.addEventListener('input', () => {
                    dataRows[rowIndex][cellIndex] = td.textContent;
                    saveData();
                });
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableContainer.appendChild(table);
        downloadBtn.disabled = false;

        // 更新 localStorage 的按钮状态
        clearDataBtn.disabled = false;
    }

    // 保存数据到localStorage
    function saveData() {
        localStorage.setItem('fileType', fileType);
        localStorage.setItem('tableHeaders', JSON.stringify(headers));
        localStorage.setItem('tableDataRows', JSON.stringify(dataRows));
    }

    // 下载按钮点击事件
    downloadBtn.addEventListener('click', () => {
        if (fileType === 'csv') {
            downloadCSV();
        } else if (fileType === 'xlsx') {
            downloadXLSX();
        }
    });

    // 下载CSV文件
    function downloadCSV() {
        if (headers.length === 0) {
            alert('没有可下载的数据');
            return;
        }
        const csv = Papa.unparse({
            fields: headers,
            data: dataRows
        });
        downloadFile(csv, 'modified.csv', 'text/csv');
    }

    // 下载XLSX文件
    function downloadXLSX() {
        if (headers.length === 0) {
            alert('没有可下载的数据');
            return;
        }
        const worksheetData = [headers, ...dataRows];
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Modified');
        const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'binary'});

        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        downloadFile(new Blob([s2ab(wbout)], {type: 'application/octet-stream'}), 'modified.xlsx', 'application/octet-stream');
    }

    // 下载文件辅助函数
    function downloadFile(content, filename, mimeType) {
        const a = document.createElement('a');
        const url = URL.createObjectURL(content instanceof Blob ? content : new Blob([content], {type: mimeType}));
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // 清空数据按钮点击事件
    clearDataBtn.addEventListener('click', () => {
        if (confirm('确定要清空所有数据吗？')) {
            localStorage.removeItem('fileType');
            localStorage.removeItem('tableHeaders');
            localStorage.removeItem('tableDataRows');
            tableContainer.innerHTML = '';
            fileTypeDisplay.textContent = '';
            downloadBtn.disabled = true;
            clearDataBtn.disabled = true;
            headers = [];
            dataRows = [];
            alert('数据已清空');
        }
    });
</script>
</body>
</html>
